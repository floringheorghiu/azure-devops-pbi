<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Azure DevOps Sync</title>
  <style>
    :root {
      --font-family-system: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      --font-size-xs: 11px;
      --font-size-sm: 12px;
      --font-size-md: 14px;
      --line-height-sm: 1.4;
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 24px;
      --color-bg: #FFFFFF;
      --color-bg-alt: #F7F7F7;
      --color-text: #1F1F1F;
      --color-text-muted: #666666;
      --color-border: #E5E5E5;
      --color-primary: #0078D4;
      --color-primary-hover: #005A9E;
      --color-danger: #D92C2C;
      --color-danger-hover: #A82222;
      --color-success: #107C10;
      --color-warning: #FFB900;
      --color-info-bg: #F2F9FF;
      --color-info-text: #004A8B;
      --color-success-bg: #DFF6DD;
      --color-error-bg: #FDE7E9;
      --border-radius-sm: 4px;
      --border-radius-md: 6px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-system);
      font-size: var(--font-size-sm);
      line-height: var(--line-height-sm);
      margin: 0;
      padding: var(--space-lg);
      background: var(--color-bg);
      color: var(--color-text);
    }

    .container {
      max-width: 100%;
    }

    .nav {
      display: flex;
      border-bottom: 1px solid var(--color-border);
      margin-bottom: var(--space-lg);
    }

    .nav-tab {
      padding: var(--space-sm) var(--space-md);
      cursor: pointer;
      border: none;
      background: none;
      font-size: var(--font-size-md);
      font-family: inherit;
      color: var(--color-text-muted);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }

    .nav-tab.active {
      color: var(--color-primary);
      border-bottom-color: var(--color-primary);
      font-weight: 600;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .form-group {
      margin-bottom: var(--space-md);
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: var(--space-xs);
    }

    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-sm);
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .help-text {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-xs);
    }

    .button-group {
      display: flex;
      gap: var(--space-sm);
      margin-top: var(--space-md);
    }

    button {
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      border: 1px solid transparent;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
    }

    .btn-secondary {
      background: var(--color-bg-alt);
      color: var(--color-text);
      border-color: var(--color-border);
    }

    .btn-secondary:hover {
      background: var(--color-border);
    }

    .btn-danger {
      background: var(--color-danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--color-danger-hover);
    }

    .status {
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--border-radius-sm);
      margin-bottom: var(--space-lg);
    }

    .status-success {
      background: var(--color-success-bg);
      color: var(--color-success);
    }

    .status-error {
      background: var(--color-error-bg);
      color: var(--color-danger);
    }

    .status-info {
      background: var(--color-info-bg);
      color: var(--color-info-text);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="nav">
      <button id="tab-create" class="nav-tab active">Create</button>
      <button id="tab-setup" class="nav-tab">Setup</button>
    </div>

    <div id="status-container"></div>

    <!-- Create View -->
    <div id="view-create" class="view active">
      <div class="form-group">
        <label for="base-url">Azure DevOps Work Item URL</label>
        <input type="text" id="base-url" placeholder="https://dev.azure.com/my-org/my-project/_workitems/edit/"
          style="color: #333;">
        <div class="help-text">Base URL (Persistent)</div>
      </div>
      <div class="form-group">
        <label for="pbi-id">PBI Number</label>
        <input type="text" id="pbi-id" placeholder="e.g. 2313096" style="font-size: 16px; font-weight: 600;">
      </div>
      <div class="button-group">
        <button id="create-widget" class="btn-primary" style="width: 100%">Populate Widget</button>
      </div>
    </div>

    <!-- Setup View -->
    <div id="view-setup" class="view">
      <div class="form-group">
        <label for="organization">Azure DevOps Organization</label>
        <input type="text" id="organization" placeholder="e.g., my-org">
      </div>

      <div class="form-group">
        <label for="pat">Personal Access Token (PAT)</label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <input type="password" id="pat" placeholder="Required: work_items_read" style="flex: 1;">
          <div id="pat-status" title="PAT Status">❌</div>
        </div>
      </div>

      <div class="form-group">
        <label for="regex-preset">AC Parsing Regex</label>
        <select id="regex-preset"
          style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); margin-bottom: 4px;">
          <option value="power">Power User (Default)</option>
          <option value="standard">Standard (AC1, AC2)</option>
          <option value="gherkin">Gherkin (Given, When, Then)</option>
          <option value="numbered">Numbered Lists (1., 2.)</option>
          <option value="custom">Custom</option>
        </select>
        <input type="text" id="ac-pattern" placeholder="Custom Regex" style="display: none;">
        <div class="help-text">
          Optional: A Regex to split Acceptance Criteria. Default is newline.
        </div>
      </div>

      <div class="form-group">
        <label for="change-log-page-name">Change Log Page Name</label>
        <input type="text" id="change-log-page-name" placeholder="Default: Change Log">
        <div class="help-text">Optional: Name of the page where logs are stored.</div>
      </div>

      <div class="form-group">
        <label>Visible Fields</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <label><input type="checkbox" id="show-type" checked> Type of item</label>
          <label><input type="checkbox" id="show-area" checked> Area Path</label>
          <label><input type="checkbox" id="show-assigned" checked> Assigned To</label>
          <label><input type="checkbox" id="show-iteration" checked> Iteration Path</label>
          <label><input type="checkbox" id="show-desc" checked> Description</label>
          <label><input type="checkbox" id="show-changed" checked> Changed By</label>
          <label><input type="checkbox" id="show-tags" checked> Tags</label>
          <label><input type="checkbox" id="show-state" checked> State</label>
          <label><input type="checkbox" id="show-done"> "Done" Status</label>
        </div>
      </div>

      <div class="button-group">
        <button id="save-pat" class="btn-primary" style="flex: 1;">Save</button>
        <button id="clear-pat" class="btn-danger" style="flex: 1;">Clear</button>
      </div>
      <div id="version-display" class="help-text" style="text-align: center; margin-top: 24px;"></div>
    </div>
  </div>

  <script>
    const tabs = {
      create: document.getElementById('tab-create'),
      setup: document.getElementById('tab-setup'),
    };
    const views = {
      create: document.getElementById('view-create'),
      setup: document.getElementById('view-setup'),
    };
    const statusContainer = document.getElementById('status-container');
    const organizationInput = document.getElementById('organization');
    const patInput = document.getElementById('pat');
    const patStatus = document.getElementById('pat-status');
    const regexPreset = document.getElementById('regex-preset');
    const acPatternInput = document.getElementById('ac-pattern');
    const baseUrlInput = document.getElementById('base-url');
    const pbiIdInput = document.getElementById('pbi-id');
    const changeLogPageNameInput = document.getElementById('change-log-page-name');
    const versionDisplay = document.getElementById('version-display');

    // Field Checkboxes
    const fields = {
      showType: document.getElementById('show-type'),
      showArea: document.getElementById('show-area'),
      showAssigned: document.getElementById('show-assigned'),
      showIteration: document.getElementById('show-iteration'),
      showDesc: document.getElementById('show-desc'),
      showChanged: document.getElementById('show-changed'),
      showTags: document.getElementById('show-tags'),
      showState: document.getElementById('show-state'),
      showDone: document.getElementById('show-done')
    };

    // Regex Presets
    const REGEX_PRESETS = {
      power: "(?:^|\\n)(?=(?:AC\\s?\\d+|SC\\s?\\d+|\\d+[\\.\\-\\)])[\\s\\S]*?)",
      standard: "(?:^|\\n)(?=AC\\s?\\d+)",
      gherkin: "(?:^|\\n)(?=(?:Given|When|Then))",
      numbered: "(?:^|\\n)(?=\\d+\\.)",
      custom: ""
    }

    // --- Event Listeners ---
    tabs.create.addEventListener('click', () => switchView('create'));
    tabs.setup.addEventListener('click', () => switchView('setup'));
    document.getElementById('save-pat').addEventListener('click', handleSaveConfig);
    document.getElementById('clear-pat').addEventListener('click', handleClearConfig);
    document.getElementById('create-widget').addEventListener('click', handleCreateWidget);

    regexPreset.addEventListener('change', () => {
      const val = regexPreset.value;
      if (val === 'custom') {
        acPatternInput.style.display = 'block';
        acPatternInput.value = ''; // Reset for custom input
      } else {
        acPatternInput.style.display = 'none';
        acPatternInput.value = REGEX_PRESETS[val];
      }
    });

    // --- Message Handling ---
    window.onmessage = (event) => {
      const { type, payload } = event.data.pluginMessage || {};
      switch (type) {
        case 'config-stored':
          handleConfigStored(payload);
          break;
        case 'init':
          handleInit(payload);
          break;
        case 'error':
          showStatus('error', payload.message);
          break;
      }
    };

    // --- UI Logic ---
    function switchView(viewName) {
      Object.values(tabs).forEach(tab => tab.classList.remove('active'));
      Object.values(views).forEach(view => view.classList.remove('active'));
      tabs[viewName].classList.add('active');
      views[viewName].classList.add('active');
    }

    function showStatus(type, message) {
      statusContainer.innerHTML = `<div class="status status-${type}">${message}</div>`;
      setTimeout(() => {
        statusContainer.innerHTML = '';
      }, 5000);
    }

    function sendMessage(type, payload) {
      parent.postMessage({ pluginMessage: { type, payload } }, '*');
    }

    // --- Event Handlers ---
    function handleSaveConfig() {
      const organization = organizationInput.value.trim();
      const pat = patInput.value.trim();
      const acPattern = regexPreset.value === 'custom' ? acPatternInput.value.trim() : REGEX_PRESETS[regexPreset.value];
      const changeLogPageName = changeLogPageNameInput.value.trim();

      const visibleFields = {};
      Object.keys(fields).forEach(key => visibleFields[key] = fields[key].checked);

      if (!organization) {
        showStatus('error', 'Organization is required.');
        return;
      }

      sendMessage('store-config', { organization, pat, acPattern, visibleFields, changeLogPageName });
    }

    function handleClearConfig() {
      sendMessage('clear-config');
      organizationInput.value = '';
      patInput.value = '';
      acPatternInput.value = '';
      changeLogPageNameInput.value = '';
      regexPreset.value = 'power';
      updatePatStatus(false);
      showStatus('info', 'Configuration cleared.');
    }

    function handleCreateWidget() {
      const base = baseUrlInput.value.trim();
      const id = pbiIdInput.value.trim();

      if (!base || !id) {
        showStatus('error', 'Please provide Base URL and PBI Number.');
        return;
      }
      let url = base;
      if (!url.endsWith('/')) url += '/';
      url += id;

      sendMessage('create-widget', { url });
    }

    baseUrlInput.addEventListener('input', () => {
      const val = baseUrlInput.value;
      // Regex to capture base URL and the trailing ID number
      // Refined to require a slash before the number to avoid stripping digits from project names (e.g. "project1")
      const match = val.match(/^(.*\/)(\d+)\/?$/);

      if (match) {
        // match[1] is the base (including the slash), match[2] is the ID
        const base = match[1];
        const id = match[2];

        // Only update if we found both parts
        if (base && id) {
          baseUrlInput.value = base;
          pbiIdInput.value = id;
          showStatus('success', 'ID extracted!');
        }
      }
    });



    function updatePatStatus(hasPat) {
      patStatus.innerHTML = hasPat ? '✅' : '❌';
    }

    // --- Plugin Message Handlers ---
    function handleInit(payload) {
      if (payload.config) {
        organizationInput.value = payload.config.organization || '';
        changeLogPageNameInput.value = payload.config.changeLogPageName || '';
        baseUrlInput.value = payload.config.lastBaseUrl || ''; // Pre-fill Last Base URL

        // Restore Regex
        const currentPattern = payload.config.acPattern || '';
        let foundPreset = false;

        // Try to match current pattern to a preset
        for (const [key, val] of Object.entries(REGEX_PRESETS)) {
          if (val === currentPattern) {
            regexPreset.value = key;
            acPatternInput.style.display = 'none';
            acPatternInput.value = val;
            foundPreset = true;
            break;
          }
        }

        if (!foundPreset && currentPattern) {
          regexPreset.value = 'custom';
          acPatternInput.style.display = 'block';
          acPatternInput.value = currentPattern;
        } else if (!currentPattern) {
          // Default to Power User if no pattern set
          regexPreset.value = 'power';
          acPatternInput.value = REGEX_PRESETS['power'];
        }

        updatePatStatus(!!payload.config.pat);

        // Restore Visible Fields
        if (payload.config.visibleFields) {
          Object.keys(fields).forEach(key => {
            if (payload.config.visibleFields.hasOwnProperty(key)) {
              fields[key].checked = payload.config.visibleFields[key];
            }
          });
        }
      } else {
        updatePatStatus(false);
        regexPreset.value = 'power';
        acPatternInput.value = REGEX_PRESETS['power'];
      }

      if (payload.version) {
        versionDisplay.innerText = 'v' + payload.version;
      }
    }

    function handleConfigStored(payload) {
      if (payload.success) {
        showStatus('success', 'Configuration saved successfully!');
        patInput.value = ''; // Clear for security
        updatePatStatus(true);
      } else {
        showStatus('error', 'Failed to save configuration.');
      }
    }

    // --- Initial State ---
    switchView('create');
  </script>
</body>

</html>